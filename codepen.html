
<!DOCTYPE html>
<html>

<head>

  <meta charset="UTF-8">

  <meta name="robots" content="noindex">

  <title>Playground - CodePen</title>

   <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, x-minimal-ui"/>

  <link rel='stylesheet prefetch' href='http://fonts.googleapis.com/css?family=Signika'>
<link rel='stylesheet prefetch' href='http://netdna.bootstrapcdn.com/bootswatch/latest/slate/bootstrap.min.css'>
<link rel='stylesheet prefetch' href='http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css'>

  <style>/*

i.fa.fa-external-link
i.fa.fa-file
span.glyphicon.glyphicon-file
span.glyphicon.glyphicon-resize-full
span.glyphicon.glyphicon-comment
i.fa.fa-expand
i.fa.fa-bars

http://fonts.googleapis.com/css?family=Signika

//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css

//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css

//netdna.bootstrapcdn.com/bootswatch/latest/slate/bootstrap.min.css

https://github.com/thomaspark/bootswatch/tree/gh-pages/slate

http://netdna.bootstrapcdn.com/bootswatch/latest/slate/bootstrap.min.css
*/
@-moz-document url-prefix() {
  fieldset {
    display: table-cell;
  }
}
.title {
  font-family: 'Signika', sans-serif;
  font-style: italic;
  color: #fff;
}
.cursor {
  cursor: pointer;
  cursor: hand;
}
.close-btn {
  position: absolute;
  top: 10px;
  right: 10px;
}</style>

</head>

<body>

<div ng-app="App">
  <div id="content" class="hidden">hi</div>
  <div ng-controller="TableCtrl as vm" class="container-fluid">
    <div class="row">
      <div id="main" class="col-xs-12">
        <h1 class="title">BehindTheSite</h1>
        <p>
          <div class="text-muted">A collection of technology stacks used by a variety of companyes and products.</div>
        </p>
        <div class="table-responsive">
          <table class="table table-striped table-bordered table-condensed small">
            <thead>
              <tr>
                <th>Product</th>
                <th ng-repeat="h in vm.headers">{{ h.name }}</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="p in vm.products">
                <td>{{ p.name }} </td>
                <td ng-repeat="t in p.tiers">
                  <ul class="list-unstyled">
                    <li ng-repeat="ea in t" data-content="{{ ea.description }}" data-title="{{ ea.name }}" item-displayed="item-displayed"><span class="cursor">{{ ea.name }}</span></li>
                  </ul>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

  <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script><script src='http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.2.0/js/bootstrap.min.js'></script><script src='http://cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.20/angular.min.js'></script>

  <script>
    /*

http://api.jquery.com/click/

https://docs.angularjs.org/api/ng/function/angular.element

http://jsfiddle.net/hajpoj/JJQS9/15/

*/

var popupTemplate = '<div class="popover" role="tooltip"><div class="arrow"></div><span class="close-btn cursor glyphicon glyphicon-remove"></span><h1 class="popover-title"></h1><div class="popover-content"></div></div>';

var App = angular.module('App', []);

App.directive('itemDisplayed', function() {
    return function(scope, element, attrs) {
//    console.log(attrs);
      var ele = angular.element(element);
      var span = ele.find('span');

      var popupConfig = {
        html: true,
        title: attrs.title,
        content: attrs.content,
        placement: 'top',
        template: popupTemplate,
        trigger: 'manual'
      };

      span.data('state', 'hover');
      span.popover(popupConfig);
      span.on('mouseenter', function (e) { 
        if (span.data('state') === 'hover') {
          span.popover('show');
        }
      });
      span.on('mouseleave', function (e) { 
        if (span.data('state') === 'hover') {
          span.popover('hide');
        }
      });
      span.on('click', function (e) { 
        if (span.data('state') === 'hover') {
            span.data('state', 'pinned');
        } else {
            span.data('state', 'hover');
            span.popover('hide');
        }
      });

      ele.on('shown.bs.popover', function () {
        ele.find('.close-btn').click( function () {
          span.data('state', 'hover');
          span.popover('hide');
        });        
      });

    };
  });

App.controller('TableCtrl', TableCtrl);

function TableCtrl($scope, $http) {

  var vm = this;
  vm.headers = [];
  vm.products = [];

  vm.getTaxonomyIds = function (taxonomy) {
    var ids = [];
    ids.push( taxonomy.id );
    for( var i in taxonomy.children ) {
      var c = taxonomy.children[i];
      ids = ids.concat( vm.getTaxonomyIds(c) );
    }
    return ids;
  }

  vm.findHeaderIndex = function (tier) {
    var id = tier.category.id;
//    console.log('Searching for: ' + id + ' ' + typeof(id) );
    for(var i in vm.headers) {
//      console.log('In: ' + vm.headers[i].ids);
      var index = $.inArray(id, vm.headers[i].ids);
      if(index > -1) {
        return i;
      }
    }
    return -1;
  }

  $http.get('http://api.behindthesite.com/v1/taxonomy/')
    .success(function(res){
      var taxonomy = res.taxonomy;
      console.log('Taxonomy: ' + taxonomy.length  );
      for(var index in taxonomy) {
        var t = taxonomy[index];
        var h = { name: t.name }
        h.ids = vm.getTaxonomyIds( t );
//        console.log( h.name + ', ' + h.ids);
        vm.headers.push( h )
      }
    })
    .error(function(res){
      console.error('Error loading Taxonomy JSON.');
    })

  $http.get('http://api.behindthesite.com/v1/stacks/')
    .success(function(res){
      var products = res.products;
      console.log('Products: ' + products.length  );
      for(var index in products) {
        var p = products[index];
        var i = { name: p.name };
        i.company = p.company;
        i.tiers = [];
        for(var h in vm.headers) {
          i.tiers[h] = []
        }
        var tiers = p.stack.tiers;
        for(var ea in tiers) {
          var index = vm.findHeaderIndex( tiers[ea] )
//          console.log('index: ' + index);
          i.tiers[index].push( tiers[ea].product )
        }
//        console.log( i.name );
//        console.log( i.tiers );
        vm.products.push( i )
      }
    })
    .error(function(res){
      console.error('Error loading Stack JSON.');
    })

}
    //@ sourceURL=pen.js
  </script>

</body>

</html>
