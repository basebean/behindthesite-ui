
<!DOCTYPE html>
<html>

<head>

  <meta charset="UTF-8">

  <meta name="robots" content="noindex">

  <title>Playground alt - CodePen</title>

   <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, x-minimal-ui"/>

  <link rel='stylesheet prefetch' href='http://fonts.googleapis.com/css?family=Signika'>
<link rel='stylesheet prefetch' href='http://netdna.bootstrapcdn.com/bootswatch/latest/slate/bootstrap.min.css'>
<link rel='stylesheet prefetch' href='http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css'>

  <style>/*

i.fa.fa-external-link
i.fa.fa-file
span.glyphicon.glyphicon-file
span.glyphicon.glyphicon-resize-full
span.glyphicon.glyphicon-comment
i.fa.fa-expand
i.fa.fa-bars

http://fonts.googleapis.com/css?family=Signika

//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css

//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css

//netdna.bootstrapcdn.com/bootswatch/latest/slate/bootstrap.min.css

https://github.com/thomaspark/bootswatch/tree/gh-pages/slate

http://netdna.bootstrapcdn.com/bootswatch/latest/slate/bootstrap.min.css
*/
@-moz-document url-prefix() {
  fieldset {
    display: table-cell;
  }
}
.title {
  font-family: 'Signika', sans-serif;
  font-style: italic;
  color: #fff;
}
.cursor {
  cursor: pointer;
  cursor: hand;
}
.close-btn {
  position: absolute;
  top: 10px;
  right: 10px;
}
.affix {
  top: 0px;
  z-index: 99999;
  color: #c8c8c8;
  background: #272b30;
  border-color: gray;
}</style>

</head>

<body>

<div class="container-fluid">
  <div class="row">
    <div class="jumbotron">
      <div class="row">
        <h2 class="title text-center">BehindTheSite</h2>
        <p class="text-center text-muted"><small>A collection of technology stacks used by a variety of companies and products. </small></p>
      </div>
      <div class="row hidden">
        <div class="col-sm-4">
          <p><small>Hi</small></p>
        </div>
        <div class="col-sm-4">
          <p> <small>Hi</small></p>
        </div>
        <div class="col-sm-4">
          <p> <small>Hi.</small></p>
        </div>
      </div>
    </div>
  </div>
  <div ng-app="btsApp" class="row container-fluid">
    <script type="text/ng-template" id="productHoverTmpl.html">
      <div class="popover" role="tooltip">
        <div class="arrow"></div>
        <span class="close-btn cursor glyphicon glyphicon-remove"></span>
        <h1 class="popover-title"></h1>
        <div class="popover-content"></div>
      </div>
    </script>
    <script type="text/ng-template" id="productHoverContentTmpl.html">
      <div>
        <p>{{ description }}</p>
        <p>
          <span ng-show='"{{twitter}}" != “”’><a href="{{ twitter }}" target="_blank">Website</a>, </span>
          <span ng-show='"{{blogs}}" != “”’><a href="{{ twitter }}" target="_blank">Twitter</a>, </span>
          <span ng-show='"{{irc}}" != “”’><a href="{{ irc }}" target="_blank">Irc</a>, </span>
          <span ng-show='"{{repo}}" != “”’><a href="{{ repo }}" target="_blank">Source-code</a>, </span>
          <span ng-show='"{{issues}}" != “”’><a href="{{ issues }}" target="_blank">Issues</a>, </span>
          <span ng-show='"{{docs}}" != “”’><a href="{{ docs }}" target="_blank">Docs</a>, </span>
          <span ng-show='"{{blogs}}" != “”’><a href="{{ blogs }}" target="_blank">Blog</a></span>
        </p> 
        </div>
    </script>
    <div ng-controller="TableCtrl as vm" class="row">
      <div id="main" class="col-xs-12"> 
        <div class="visible-xs">
          <p ng-repeat="p in vm.products | nocraigslist">{{ p.name }}</p>
        </div>
        <div class="hidden-xs">
          <table class="table table-striped table-bordered table-condensed small">
            <thead affix="affix"> 
              <tr>
                <th>Products</th>
                <th ng-repeat="h in vm.headers">{{ h.name }}</th>
              </tr>
            </thead>
            <tbody>
              <tr ng-repeat="product in vm.products">
                <td>{{ product.name }}</td>
                <td ng-repeat="tier in product.tiers">
                  <ul class="list-unstyled">
                    <li ng-repeat="ea in tier" data-description="{{ ea.description }}" data-title="{{ ea.name }}" data-website="{{ ea.website }}" data-twitter="{{ ea.twitter }}" data-irc="{{ ea.irc }}" data-blogs="{{ ea.blogs }}" data-repo="{{ ea.repo }}" data-issues="{{ ea.issues }}" data-docs="{{ ea.docs }}" item-displayed="item-displayed"><span class="cursor">{{ ea.name }} </span></li>
                  </ul>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

  <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script><script src='http://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.2.0/js/bootstrap.min.js'></script><script src='http://cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.20/angular.min.js'></script><script src='http://cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.20/angular-resource.min.js'></script><script src='http://cdnjs.cloudflare.com/ajax/libs/angular.js/1.2.20/angular-route.min.js'></script>

  <script>
    /*

http://api.jquery.com/
https://docs.angularjs.org/api/ng/function/angular.element
http://jsfiddle.net/hajpoj/JJQS9/15/
https://thinkster.io/angulartutorial/a-better-way-to-learn-angularjs/
https://docs.angularjs.org/

*/

//*****************************************************************************
// App

var btsApp = angular.module('btsApp', ['btsControllers', 'btsDirectives', 'btsFilters', 'btsServices']);

//*****************************************************************************
// Services
// https://docs.angularjs.org/api/ngResource/service/$resource

var btsServices = angular.module('btsServices', ['ngResource']);

btsServices.factory('TaxonomySvc', ['$resource',
  function($resource){
    return $resource('http://api.behindthesite.com/v1/taxonomy/');
  }]);

btsServices.factory('StackSvc', ['$resource',
  function($resource){
    return $resource('http://api.behindthesite.com/v1/stacks/');
  }]);

//*****************************************************************************
// Directives
// https://docs.angularjs.org/guide/directive

var btsDirectives = angular.module('btsDirectives', []);

btsDirectives.directive('affix', function($templateCache) {
  console.log('affix')
    return function(scope, element, attrs) {
      var ele = angular.element(element);

      scope.affix_widths = [];

      ele.affix({
        offset: {
          top: function() { 
            return  $('#main').offset().top;
          }
        }
      })

      ele.on('affix.bs.affix', function (e) {
        console.log('affix.prior');

        var ths = ele.find('th');
        ths.each(function(i) { 
          scope.affix_widths[i] = $(this).width();
        })

      });

      ele.on('affixed.bs.affix', function (e) {
        console.log('affix.post');
        var ths = ele.find('th');
        ths.each(function(i) {
          $(this).width(scope.affix_widths[i]);
          console.log(scope.affix_widths[i])
        })
      });

    };
  });

btsDirectives.directive('itemDisplayed', function($templateCache, $compile) {
  console.log('itemDisplayed')
    return function(scope, element, attrs) {
      var ele = angular.element(element);
      var span = ele.find('span');

      var tmpl = $templateCache.get('productHoverTmpl.html')
      scope.website = attrs.website;
      scope.twitter = attrs.twitter;
      scope.irc = attrs.irc;
      scope.blogs = attrs.blogs;
      scope.description = attrs.description;
      scope.repo = attrs.repo;
      scope.issues = attrs.issues;
      scope.docs = attrs.docs;
      // https://docs.angularjs.org/api/ng/service/$compile
      var contentHtml = $compile($templateCache.get('productHoverContentTmpl.html'))(scope);

      var popupConfig = {
        html: true,
        title: attrs.title,
        content: contentHtml,
        placement: 'top',
        template: tmpl,
        trigger: 'manual'
      };

      span.data('state', 'hover');
      span.popover(popupConfig);
      span.on('mouseenter', function (e) { 
        if (span.data('state') === 'hover') {
          span.popover('show');
        }
      });
      span.on('mouseleave', function (e) { 
        if (span.data('state') === 'hover') {
          span.popover('hide');
        }
      });
      span.on('click', function (e) { 
        if (span.data('state') === 'hover') {
            span.data('state', 'pinned');
        } else {
            span.data('state', 'hover');
            span.popover('hide');
        }
      });

      ele.on('shown.bs.popover', function () {
        ele.find('.close-btn').click( function () {
          span.data('state', 'hover');
          span.popover('hide');
        });        
      });

    };
  });

//*****************************************************************************
// filters
// https://docs.angularjs.org/guide/filter

var btsFilters = angular.module('btsFilters', []);

btsFilters.filter('nocraigslist', function() {
  return function(input) {
    var output = [];
    if(input) {
      for(var i in input) {
        if(input[i].name != 'Craigslist Website' ) {
          output.push(input[i]);
        }
      }
    }
    return output;
  };
});

//*****************************************************************************
// Controllers
// https://docs.angularjs.org/api/ng/directive/ngController

var btsControllers = angular.module('btsControllers', []);

btsControllers.controller('TableCtrl', TableCtrl);

function TableCtrl($scope, TaxonomySvc, StackSvc) {

  var vm = this;
  vm.headers = [];
  vm.products = [];

  vm.getTaxonomyIds = function (taxonomy) {
    var ids = [];
    ids.push( taxonomy.id );
    for( var i in taxonomy.children ) {
      var c = taxonomy.children[i];
      ids = ids.concat( vm.getTaxonomyIds(c) );
    }
    return ids;
  }

  vm.findHeaderIndex = function (tier) {
    var id = tier.category.id;
//    console.log('Searching for: ' + id + ' ' + typeof(id) );
    for(var i in vm.headers) {
//      console.log('In: ' + vm.headers[i].ids);
      var index = $.inArray(id, vm.headers[i].ids);
      if(index > -1) {
        return i;
      }
    }
    return -1;
  }

  TaxonomySvc.get(function(res) {
      var taxonomy = res.taxonomy;
      console.log('Taxonomy: ' + taxonomy.length  );
      for(var index in taxonomy) {
        var t = taxonomy[index];
        var h = { name: t.name }
        h.ids = vm.getTaxonomyIds( t );
//        console.log( h.name + ', ' + h.ids);
        vm.headers.push( h )
      }

    });

  StackSvc.get(function(res) {
      var products = res.products;
      console.log('Products: ' + products.length  );
      for(var index in products) {
        var product = products[index];
        var model = { name: product.name };
        model.company = product.company;
        model.tiers = [];
        for(var header in vm.headers) {
          model.tiers[header] = []
        }
        var tiers = product.stack.tiers;
        for(var tier in tiers) {
          var index = vm.findHeaderIndex( tiers[tier] )
//          console.log('index: ' + index);
//          console.log(tiers[tier].product);
          model.tiers[index].push( tiers[tier].product )
        }
//        console.log( i.name );
//        console.log( i.tiers );
        vm.products.push( model )
      } 

    // https://docs.angularjs.org/api/ng/type/$rootScope.Scope#$broadcast downward
    // https://docs.angularjs.org/api/ng/type/$rootScope.Scope#emit upward
      $scope.$emit('TableCtrl.completed');    
      $scope.$broadcast('TableCtrl.completed');

    });

}
    //@ sourceURL=pen.js
  </script>

</body>

</html>
